parameters:
  - name: ServiceConnection
    type: string
  - name: ResourceGroupName
    type: string
  - name: Environment
    type: string
  - name: GrafanaWorkspaceName
    type: string
  - name: Location
    type: string
    default: 'westus2'
  - name: GrafanaIdentityId
    type: string

steps:
  - task: AzureCLI@2
    displayName: 'Validate Application Gateway Bicep Template'
    inputs:
      azureSubscription: ${{ parameters.ServiceConnection }}
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        Write-Host "Validating Application Gateway Bicep template..."
        az bicep build --file eng/deployment/azure-appgw-grafana.bicep
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Bicep validation failed"
          exit 1
        }
        Write-Host "âœ“ Application Gateway Bicep template is valid"

  - task: AzureCLI@2
    displayName: 'Get Grafana Endpoint'
    inputs:
      azureSubscription: ${{ parameters.ServiceConnection }}
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        Write-Host "Retrieving Grafana workspace endpoint..."
        $grafanaEndpointFull = az grafana show `
          --name "${{ parameters.GrafanaWorkspaceName }}" `
          --resource-group "${{ parameters.ResourceGroupName }}" `
          --query "properties.endpoint" `
          --output tsv
        
        if ([string]::IsNullOrEmpty($grafanaEndpointFull)) {
          Write-Error "Failed to retrieve Grafana endpoint"
          exit 1
        }
        
        # Remove https:// prefix and trailing slash for Application Gateway backend
        $grafanaEndpoint = $grafanaEndpointFull -replace '^https://', '' -replace '/$', ''
        
        Write-Host "Grafana Full Endpoint: $grafanaEndpointFull"
        Write-Host "Grafana Backend FQDN: $grafanaEndpoint"
        Write-Host "##vso[task.setvariable variable=GrafanaEndpoint]$grafanaEndpoint"
        Write-Host "##vso[task.setvariable variable=GrafanaEndpointFull]$grafanaEndpointFull"

  - task: AzureCLI@2
    displayName: 'Grant Pipeline Service Principal Key Vault Certificate Access'
    inputs:
      azureSubscription: ${{ parameters.ServiceConnection }}
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        Write-Host "Granting pipeline service principal Key Vault Certificates Officer role..."
        
        $kvName = if ("${{ parameters.Environment }}" -eq "Production") { "dnceng-amg-prod-kv" } else { "dnceng-amg-int-kv" }
        $rgName = "${{ parameters.ResourceGroupName }}"
        
        # Get the current service principal object ID
        $spObjectId = az account show --query "user.name" --output tsv
        Write-Host "Service Principal Object ID: $spObjectId"
        
        # Get the Key Vault resource ID
        $kvId = az keyvault show --name $kvName --resource-group $rgName --query "id" --output tsv
        Write-Host "Key Vault: $kvName"
        Write-Host "Key Vault ID: $kvId"
        
        # Check if role assignment already exists
        $existingAssignment = az role assignment list `
          --assignee $spObjectId `
          --scope $kvId `
          --role "Key Vault Certificates Officer" `
          --query "[0].id" `
          --output tsv
        
        if ($existingAssignment) {
          Write-Host "âœ“ Pipeline service principal already has Key Vault Certificates Officer role"
        } else {
          Write-Host "Granting Key Vault Certificates Officer role..."
          az role assignment create `
            --role "Key Vault Certificates Officer" `
            --assignee $spObjectId `
            --scope $kvId `
            --output none
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ“ Pipeline service principal granted Key Vault Certificates Officer role"
            Write-Host "â±  Waiting 30 seconds for role assignment to propagate..."
            Start-Sleep -Seconds 30
          } else {
            Write-Error "Failed to grant Key Vault Certificates Officer role"
            exit 1
          }
        }

  - task: AzureCLI@2
    displayName: 'Setup Certificate in Key Vault'
    inputs:
      azureSubscription: ${{ parameters.ServiceConnection }}
      scriptType: 'pscore'
      scriptLocation: 'scriptPath'
      scriptPath: 'eng/generate-appgw-cert.ps1'
      ${{ if eq(parameters.Environment, 'Staging') }}:
        arguments: >-
          -DnsName "dnceng-managed-grafana-staging.${{ parameters.Location }}.cloudapp.azure.com"
          -KeyVaultName "dnceng-amg-int-kv"
          -ResourceGroupName "${{ parameters.ResourceGroupName }}"
          -Location "${{ parameters.Location }}"
      ${{ if eq(parameters.Environment, 'Production') }}:
        arguments: >-
          -DnsName "dnceng-managed-grafana.${{ parameters.Location }}.cloudapp.azure.com"
          -KeyVaultName "dnceng-amg-prod-kv"
          -ResourceGroupName "${{ parameters.ResourceGroupName }}"
          -Location "${{ parameters.Location }}"

  - task: AzureResourceManagerTemplateDeployment@3
    displayName: 'Deploy Application Gateway for Grafana'
    inputs:
      deploymentScope: 'Resource Group'
      azureResourceManagerConnection: ${{ parameters.ServiceConnection }}
      action: 'Create Or Update Resource Group'
      resourceGroupName: ${{ parameters.ResourceGroupName }}
      location: ${{ parameters.Location }}
      templateLocation: 'Linked artifact'
      csmFile: 'eng/deployment/azure-appgw-grafana.bicep'
      overrideParameters: >-
        -environment "${{ parameters.Environment }}"
        -location "${{ parameters.Location }}"
        -grafanaEndpoint "$(GrafanaEndpoint)"
        -certSecretId "$(KeyVaultSecretId)"
        -grafanaUserAssignedIdentityId "${{ parameters.GrafanaIdentityId }}"
      deploymentMode: 'Incremental'
      deploymentOutputs: 'AppGatewayOutputs'

  - task: AzureCLI@2
    displayName: 'Grant Application Gateway Access to Key Vault'
    inputs:
      azureSubscription: ${{ parameters.ServiceConnection }}
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        Write-Host "Granting Application Gateway managed identity access to Key Vault..."
        
        $outputs = '$(AppGatewayOutputs)' | ConvertFrom-Json
        $appGwIdentity = $outputs.applicationGatewayIdentity.value
        $kvName = "$(KeyVaultName)"
        
        Write-Host "Application Gateway Identity: $appGwIdentity"
        Write-Host "Key Vault: $kvName"
        
        # Get the Key Vault resource ID
        $rgName = "${{ parameters.ResourceGroupName }}"
        $kvId = az keyvault show --name $kvName --resource-group $rgName --query "id" --output tsv
        
        Write-Host "Key Vault ID: $kvId"
        
        # Check if role assignment already exists
        $existingAssignment = az role assignment list `
          --assignee $appGwIdentity `
          --scope $kvId `
          --role "Key Vault Secrets User" `
          --query "[0].id" `
          --output tsv
        
        if ($existingAssignment) {
          Write-Host "âœ“ Application Gateway already has Key Vault Secrets User role"
        } else {
          Write-Host "Granting Key Vault Secrets User role (RBAC)..."
          az role assignment create `
            --role "Key Vault Secrets User" `
            --assignee $appGwIdentity `
            --scope $kvId `
            --output none
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ“ Application Gateway can now access certificates from Key Vault"
          } else {
            Write-Error "Failed to grant Key Vault access"
            exit 1
          }
        }


  - task: AzureCLI@2
    displayName: 'Display Custom Domain Information'
    inputs:
      azureSubscription: ${{ parameters.ServiceConnection }}
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        Write-Host "================================================"
        Write-Host "APPLICATION GATEWAY CUSTOM DOMAIN DEPLOYED"
        Write-Host "================================================"
        
        $outputs = '$(AppGatewayOutputs)' | ConvertFrom-Json
        
        $customDomain = $outputs.customDomainName.value
        $customDomainUrl = $outputs.customDomainUrl.value
        $accessUrl = $outputs.accessUrl.value
        $publicIp = $outputs.publicIpAddress.value
        $appGwName = $outputs.applicationGatewayName.value
        
        Write-Host ""
        Write-Host "Environment: ${{ parameters.Environment }}"
        Write-Host "Application Gateway: $appGwName"
        Write-Host "Public IP Address: $publicIp"
        Write-Host "Custom Domain: $customDomain"
        Write-Host ""
        Write-Host "================================================"
        Write-Host "IMMEDIATE ACCESS (NO DNS SETUP REQUIRED)"
        Write-Host "================================================"
        Write-Host ""
        Write-Host "ðŸŽ‰ Your Grafana is immediately accessible at:"
        Write-Host "   $accessUrl"
        Write-Host ""
        Write-Host "ðŸ”’ HTTPS-only configuration"
        Write-Host "   Certificate managed in Azure Key Vault"
        Write-Host "   Self-signed certificate (browser will show security warning)"
        Write-Host ""
        Write-Host "The cloudapp.azure.com domain is automatically configured!"
        Write-Host "No DNS records needed - the domain works right away."
        Write-Host ""
        Write-Host "Original Grafana Endpoint: $(GrafanaEndpointFull)"
        Write-Host "Backend FQDN: $(GrafanaEndpoint)"
        Write-Host ""
        Write-Host "================================================"
        Write-Host "NEXT STEPS"
        Write-Host "================================================"
        Write-Host "1. Wait 2-5 minutes for Application Gateway to become healthy"
        Write-Host "2. Access Grafana at: $accessUrl"
        Write-Host "3. Accept the self-signed certificate warning in your browser"
        Write-Host "4. HTTPS traffic is proxied to Grafana HTTPS backend"
        Write-Host "5. Health probe monitors: $(GrafanaEndpointFull)/api/health"
        Write-Host ""
        Write-Host "   Certificate managed in Key Vault: $(KeyVaultName)"
        Write-Host "   Thumbprint: $(CertificateThumbprint)"
        Write-Host ""
        Write-Host "    HTTP (port 80) is DISABLED - only HTTPS is supported"
        Write-Host ""
        Write-Host "    For production, replace the self-signed certificate:"
        Write-Host "   1. Import CA-signed certificate to Key Vault:"
        Write-Host "      az keyvault certificate import --vault-name $(KeyVaultName) \"
        Write-Host "        --name appgw-ssl-cert --file certificate.pfx"
        Write-Host "   2. Application Gateway auto-updates (no redeployment needed)"
        Write-Host ""
        Write-Host "The domain $customDomain is ready to use!"
        Write-Host ""
        Write-Host "================================================"

  - task: AzureCLI@2
    displayName: 'Verify Application Gateway Deployment'
    inputs:
      azureSubscription: ${{ parameters.ServiceConnection }}
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        Write-Host "Verifying Application Gateway deployment..."
        
        $outputs = '$(AppGatewayOutputs)' | ConvertFrom-Json
        $appGwName = $outputs.applicationGatewayName.value
        $customDomain = $outputs.customDomainName.value
        
        $maxAttempts = 10
        $attempt = 0
        $verified = $false
        
        while ($attempt -lt $maxAttempts -and -not $verified) {
          $attempt++
          Write-Host "Verification attempt $attempt of $maxAttempts..."
          
          try {
            $provisioningState = az network application-gateway show `
              --name "$appGwName" `
              --resource-group "${{ parameters.ResourceGroupName }}" `
              --query "provisioningState" `
              --output tsv
            
            Write-Host "Provisioning State: $provisioningState"
            
            if ($provisioningState -eq "Succeeded") {
              Write-Host "âœ“ Application Gateway deployed successfully"
              
              # Check operational state
              $operationalState = az network application-gateway show `
                --name "$appGwName" `
                --resource-group "${{ parameters.ResourceGroupName }}" `
                --query "operationalState" `
                --output tsv
              
              Write-Host "Operational State: $operationalState"
              
              if ($operationalState -eq "Running") {
                Write-Host "âœ“ Application Gateway is running"
                $verified = $true
              } else {
                Write-Host "Waiting for Application Gateway to start..."
                Start-Sleep -Seconds 15
              }
            } else {
              Write-Host "Application Gateway still provisioning..."
              Start-Sleep -Seconds 15
            }
          } catch {
            Write-Warning "Verification attempt $attempt failed: $_"
            Start-Sleep -Seconds 15
          }
        }
        
        if (-not $verified) {
          Write-Error "Failed to verify Application Gateway deployment after $maxAttempts attempts"
          exit 1
        }
        
        Write-Host "âœ“ Application Gateway deployment verified successfully"
        Write-Host ""
        Write-Host "ðŸŽ‰ SUCCESS! Grafana is now accessible at: https://$customDomain"
        Write-Host "   (HTTPS only - HTTP disabled)"
        Write-Host ""
        Write-Host "Note: Backend health probes may take an additional 2-5 minutes to show as healthy"
        Write-Host "You can check status with:"
        Write-Host "az network application-gateway show-backend-health \"
        Write-Host "  --name $appGwName \"
        Write-Host "  --resource-group ${{ parameters.ResourceGroupName }}"